{{/*
  Partial for responsive, optimized images within templates.
  Context (.): dict "src" "alt"
*/}}
{{ $src := .src }}
{{ $alt := .alt | default "" }}

{{ if $src }}
  {{ $imagePath := printf "images/%s" $src }}
  {{ $original := resources.Get $imagePath }}

  {{ if $original }}
    {{ warnf "Partial image-service - src from context: %s" $src }}
    {{ warnf "Partial image-service - constructed image path: %s" $imagePath }}
    {{ warnf "Partial image-service - original resource exists: true" }}
    {{ warnf "Partial image-service - Resource RelPermalink: %s" $original.RelPermalink }}
    {{ warnf "Partial image-service - Resource MediaType: %s" $original.MediaType }}
    {{ warnf "Partial image-service - Resource Name: %s" $original.Name }}

    {{/* Define image widths and formats */}}
    {{ $widths := slice 480 800 1200 }}
    {{ $fallbackFormat := "jpg" }}

    {{/* --- WebP Sources --- */}}
    {{ $webpSrcs := slice }}
    {{ range $widths }}
      {{ $img := $original.Resize (printf "%dx webp" .) }}
      {{ $webpSrcs = $webpSrcs | append (printf "%s %dw" $img.RelPermalink .) }}
    {{ end }}
    {{ $webpSrcset := delimit $webpSrcs ", " }}

    {{/* --- Fallback Sources (JPEG) --- */}}
    {{ $fallbackSrcs := slice }}
    {{ range $widths }}
      {{ $img := $original.Resize (printf "%dx %s" . $fallbackFormat) }}
      {{ $fallbackSrcs = $fallbackSrcs | append (printf "%s %dw" $img.RelPermalink .) }}
    {{ end }}
    {{ $fallbackSrcset := delimit $fallbackSrcs ", " }}

    {{/* Get the smallest image for the default src attribute */}}
    {{ $smallestFallback := $original.Resize (printf "%dx %s" (index $widths 0) $fallbackFormat) }}

    <picture>
      <source
        type="image/webp"
        srcset="{{ $webpSrcset }}"
        sizes="(max-width: 600px) 480px, 800px">
      <source
        type="image/jpeg"
        srcset="{{ $fallbackSrcset }}"
        sizes="(max-width: 600px) 480px, 800px">
      <img
        src="{{ $smallestFallback.RelPermalink }}"
        alt="{{ $alt }}"
        loading="lazy"
        decoding="async"
        width="{{ $original.Width }}"
        height="{{ $original.Height }}"
      >
    </picture>
  {{ else }}
    {{ warnf "Partial image-service - original resource not found for path: %s" $imagePath }}
    <p>Image not found: {{ $src }}</p>
  {{ end }}
{{ else }}
  {{ warnf "Partial image-service - No 'src' attribute provided." }}
  <p>Error: Image partial missing 'src' attribute.</p>
{{ end }}